function md5cycle(a,b){var c=a[0],d=a[1],e=a[2],f=a[3];c=ff(c,d,e,f,b[0],7,-680876936),f=ff(f,c,d,e,b[1],12,-389564586),e=ff(e,f,c,d,b[2],17,606105819),d=ff(d,e,f,c,b[3],22,-1044525330),c=ff(c,d,e,f,b[4],7,-176418897),f=ff(f,c,d,e,b[5],12,1200080426),e=ff(e,f,c,d,b[6],17,-1473231341),d=ff(d,e,f,c,b[7],22,-45705983),c=ff(c,d,e,f,b[8],7,1770035416),f=ff(f,c,d,e,b[9],12,-1958414417),e=ff(e,f,c,d,b[10],17,-42063),d=ff(d,e,f,c,b[11],22,-1990404162),c=ff(c,d,e,f,b[12],7,1804603682),f=ff(f,c,d,e,b[13],12,-40341101),e=ff(e,f,c,d,b[14],17,-1502002290),d=ff(d,e,f,c,b[15],22,1236535329),c=gg(c,d,e,f,b[1],5,-165796510),f=gg(f,c,d,e,b[6],9,-1069501632),e=gg(e,f,c,d,b[11],14,643717713),d=gg(d,e,f,c,b[0],20,-373897302),c=gg(c,d,e,f,b[5],5,-701558691),f=gg(f,c,d,e,b[10],9,38016083),e=gg(e,f,c,d,b[15],14,-660478335),d=gg(d,e,f,c,b[4],20,-405537848),c=gg(c,d,e,f,b[9],5,568446438),f=gg(f,c,d,e,b[14],9,-1019803690),e=gg(e,f,c,d,b[3],14,-187363961),d=gg(d,e,f,c,b[8],20,1163531501),c=gg(c,d,e,f,b[13],5,-1444681467),f=gg(f,c,d,e,b[2],9,-51403784),e=gg(e,f,c,d,b[7],14,1735328473),d=gg(d,e,f,c,b[12],20,-1926607734),c=hh(c,d,e,f,b[5],4,-378558),f=hh(f,c,d,e,b[8],11,-2022574463),e=hh(e,f,c,d,b[11],16,1839030562),d=hh(d,e,f,c,b[14],23,-35309556),c=hh(c,d,e,f,b[1],4,-1530992060),f=hh(f,c,d,e,b[4],11,1272893353),e=hh(e,f,c,d,b[7],16,-155497632),d=hh(d,e,f,c,b[10],23,-1094730640),c=hh(c,d,e,f,b[13],4,681279174),f=hh(f,c,d,e,b[0],11,-358537222),e=hh(e,f,c,d,b[3],16,-722521979),d=hh(d,e,f,c,b[6],23,76029189),c=hh(c,d,e,f,b[9],4,-640364487),f=hh(f,c,d,e,b[12],11,-421815835),e=hh(e,f,c,d,b[15],16,530742520),d=hh(d,e,f,c,b[2],23,-995338651),c=ii(c,d,e,f,b[0],6,-198630844),f=ii(f,c,d,e,b[7],10,1126891415),e=ii(e,f,c,d,b[14],15,-1416354905),d=ii(d,e,f,c,b[5],21,-57434055),c=ii(c,d,e,f,b[12],6,1700485571),f=ii(f,c,d,e,b[3],10,-1894986606),e=ii(e,f,c,d,b[10],15,-1051523),d=ii(d,e,f,c,b[1],21,-2054922799),c=ii(c,d,e,f,b[8],6,1873313359),f=ii(f,c,d,e,b[15],10,-30611744),e=ii(e,f,c,d,b[6],15,-1560198380),d=ii(d,e,f,c,b[13],21,1309151649),c=ii(c,d,e,f,b[4],6,-145523070),f=ii(f,c,d,e,b[11],10,-1120210379),e=ii(e,f,c,d,b[2],15,718787259),d=ii(d,e,f,c,b[9],21,-343485551),a[0]=add32(c,a[0]),a[1]=add32(d,a[1]),a[2]=add32(e,a[2]),a[3]=add32(f,a[3])}function cmn(a,b,c,d,e,f){return b=add32(add32(b,a),add32(d,f)),add32(b<<e|b>>>32-e,c)}function ff(a,b,c,d,e,f,g){return cmn(b&c|~b&d,a,b,e,f,g)}function gg(a,b,c,d,e,f,g){return cmn(b&d|c&~d,a,b,e,f,g)}function hh(a,b,c,d,e,f,g){return cmn(b^c^d,a,b,e,f,g)}function ii(a,b,c,d,e,f,g){return cmn(c^(b|~d),a,b,e,f,g)}function md51(a){txt="";var b,c=a.length,d=[1732584193,-271733879,-1732584194,271733878];for(b=64;b<=a.length;b+=64)md5cycle(d,md5blk(a.substring(b-64,b)));a=a.substring(b-64);var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(b=0;b<a.length;b++)e[b>>2]|=a.charCodeAt(b)<<(b%4<<3);if(e[b>>2]|=128<<(b%4<<3),b>55)for(md5cycle(d,e),b=0;16>b;b++)e[b]=0;return e[14]=8*c,md5cycle(d,e),d}function md5blk(a){var b,c=[];for(b=0;64>b;b+=4)c[b>>2]=a.charCodeAt(b)+(a.charCodeAt(b+1)<<8)+(a.charCodeAt(b+2)<<16)+(a.charCodeAt(b+3)<<24);return c}function rhex(a){for(var b="",c=0;4>c;c++)b+=hex_chr[a>>8*c+4&15]+hex_chr[a>>8*c&15];return b}function hex(a){for(var b=0;b<a.length;b++)a[b]=rhex(a[b]);return a.join("")}function md5(a){return hex(md51(a))}function add32(a,b){return a+b&4294967295}function add32(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}var hex_chr="0123456789abcdef".split("");"5d41402abc4b2a76b9719d911017c592"!=md5("hello");var RoomForm=React.createClass({componentWillMount:function(){this.channel=postal.channel(),this._boundForceUpdate=this.forceUpdate.bind(this,null),this.props.rooms.on("add change remove",this._boundForceUpdate,this)},componentWillUnmount:function(){this.props.rooms.off("add change remove",this._boundForceUpdate)},joinRoomHandler:function(){this.channel.publish("Room.Join",{roomName:React.findDOMNode(this.refs.roomName).value})},render:function(){return React.DOM.div({className:"col-sm-8 col-sm-offset-2"},React.DOM.h2(null,"Please Select a Room"),React.DOM.input({type:"text",placeholder:"Room Name",className:"form-control",ref:"roomName"},null),React.DOM.button({className:"btn btn-primary btn-block top-margin",onClick:this.joinRoomHandler},"Join Room"),React.DOM.ul(null,this.props.rooms.map(function(a){return React.DOM.li({className:"list-unstyled"},React.DOM.a({href:"#room/"+a.get("name")},a.get("name")))})))}}),UserView=React.createClass({render:function(){this.props.userName?this.props.user.get("user"):null;return React.DOM.div(null,React.DOM.img({src:this.props.user.image(this.props.size),className:"img-circle",title:this.props.user.get("user")}))}}),UserList=React.createClass({render:function(){var a=this.props.me;return React.DOM.ul({className:"list-unstyled"},this.props.collection.map(function(b){return a.id!==b.get("id")?React.DOM.li(null,React.createElement(UserView,{user:b,size:50,userName:!0})):void 0}))}}),ChatMessage=React.createClass({render:function(){var a;a=this.props.me.id===this.props.chat.get("user").id?"pull-right":"pull-left";var b=moment(this.props.chat.get("ts")).fromNow();return React.DOM.li(null,React.DOM.div({className:"bg-primary chat-message "+a},this.props.chat.get("message")),React.DOM.div({className:"clearfix"},null),React.DOM.div({className:a},React.createElement(UserView,{user:this.props.chat.get("user"),size:20,userName:!0})),React.DOM.div({className:"clearfix"},null),React.DOM.small({className:a},b),React.DOM.div({className:"clearfix"},null))}}),ChatList=React.createClass({render:function(){var a=this.props.me;return React.DOM.ul({className:"list-unstyled"},this.props.chats.map(function(b){return React.createElement(ChatMessage,{chat:b,me:a})}))}}),ChatForm=React.createClass({componentWillMount:function(){this.channel=postal.channel()},formSubmit:function(a){a.preventDefault();var b=React.findDOMNode(this.refs.message).value;""!==b?(this.channel.publish("Chat.Add",{message:b}),React.findDOMNode(this.refs.message).value="",React.findDOMNode(this.refs.message).placeholder=""):React.findDOMNode(this.refs.message).placeholder="Please enter a message"},render:function(){return React.DOM.div({className:"row"},React.DOM.form({onSubmit:this.formSubmit},React.DOM.div({className:"col-sm-2"},React.createElement(UserView,{user:this.props.me,size:50,userName:!0})),React.DOM.div({className:"col-sm-8"},React.DOM.input({type:"text",className:"form-control",ref:"message"},null)),React.DOM.div({className:"col-sm-2"},React.DOM.button({className:"btn btn-primary"},"Send"))))}}),ChatView=React.createClass({componentWillMount:function(){var a=postal.channel();this._boundForceUpdate=this.forceUpdate.bind(this,null),this.props.chats.on("add change remove",this._boundForceUpdate,this),this.props.users.on("add change remove",this._boundForceUpdate,this),this.chatSub=a.subscribe("Chat.Add",this.chatAdd)},componentWillUnmount:function(){this.props.chats.off("add change remove",this._boundForceUpdate),this.props.users.off("add change remove",this._boundForceUpdate),this.chatSub.unsubscribe()},componentDidUpdate:function(){var a=React.findDOMNode(this.refs.chatList);a.scrollTop=a.scrollHeight},chatAdd:function(a){this.props.chats.sync("create",{message:a.message,room:this.props.room})},render:function(){return React.DOM.div({className:"row"},React.DOM.div({className:"row"},React.DOM.div({className:"col-sm-2"},React.createElement(UserList,{collection:this.props.users,me:this.props.me})),React.DOM.div({className:"col-sm-8 chat-list",ref:"chatList"},React.createElement(ChatList,{chats:this.props.chats,me:this.props.me}))),React.createElement(ChatForm,{me:this.props.me}))}}),SocketListener=function(a,b,c){var d=function(a){b.add(b.parse(a))},e=function(a){b.remove(b.parse(a))};c.on("Add"+a,d),c.on("Get"+a,d),c.on("Remove"+a,e);var f=function(){c.removeListener("Add"+a,d),c.removeListener("Get"+a,d),c.removeListener("Remove"+a,e)};return{destroy:f}},SocketSync=function(a,b,c){var d=Backbone.socket,e=function(a,b,c){d.emit("Add"+c,a)},f=function(a,b,c){d.emit("Get"+c,b)};switch(a){case"create":e(b,c,this.noun);break;case"read":f(b,c,this.noun)}},User=Backbone.Model.extend({image:function(a){switch(this.get("type")){case"local":return this.gravatar(a);case"facebook":return this.facebook(a);case"google":return this.gravatar(a)}},gravatar:function(a){return"http://www.gravatar.com/avatar/"+md5(this.get("id"))+"?d=retro&s="+a},facebook:function(a){return"http://graph.facebook.com/"+this.get("id")+"/picture/?height="+a}}),UserCollection=Backbone.Collection.extend({model:User}),RoomCollection=Backbone.Collection.extend(),ChatCollection=Backbone.Collection.extend({parse:function(a){return Array.isArray(a)?_.map(a,function(a){return a.user=new User(a.user),a}):(a.user=new User(a.user),a)}}),Router=Backbone.Router.extend({routes:{"":"RoomSelection","room/:room":"JoinRoom","*default":"Default"}}),PacktChat=window.PacktChat||{};PacktChat.Chat=function(a){var b,c,d,e,f=$("#"+a),g=io.connect("undefined"),h=null,i=!1,j=function(a){h=new User(a),Backbone.history.stop(),k(h),Backbone.history.start(),i=!0};g.on("connect",function(){i||g.emit("GetMe")}),g.on("GetMe",j);var k=function(){function a(a){c.add({name:a.roomName,id:a.roomName}),b.navigate("room/"+a.roomName,{trigger:!0})}function i(){c.sync("create",{name:"lobby",id:"lobby"}),React.unmountComponentAtNode(f[0]),React.render(React.createElement(RoomForm,{rooms:c}),f[0])}function j(a){d.reset(),e.reset(),c.sync("create",{name:a,id:a}),e.fetch({room:a}),d.fetch({room:a}),React.unmountComponentAtNode(f[0]),React.render(React.createElement(ChatView,{users:d,chats:e,room:a,me:h}),f[0])}function k(){b.navigate("",{trigger:!0})}b=new Router,Backbone.socket=g,Backbone.sync=SocketSync,c=new RoomCollection,c.noun="Room",d=new UserCollection,d.noun="User",e=new ChatCollection,e.noun="Chat";new SocketListener("Room",c,g),new SocketListener("User",d,g),new SocketListener("Chat",e,g);c.fetch();var l=postal.channel();l.subscribe("Room.Join",a);b.on("route:RoomSelection",i),b.on("route:JoinRoom",j),b.on("route:Default",k)}};var pc=new PacktChat.Chat("react-root");